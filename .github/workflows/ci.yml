name: Python CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build_and_test:
    name: Lint, Type Check, and Test (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.11', '3.12']

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'uv'

    - name: Install Dependencies using uv
      run: |
        # Install core tools: ruff (lint/format), pytest (test)
        uv install --system ruff pytest
        # Install project dependencies (assuming a requirements.txt or pyproject.toml)
        if [ -f requirements.txt ]; then
          uv pip install -r requirements.txt
        fi

    - name: Verify Code Formatting with Ruff
      # --fix should NOT be run in CI, only --check
      run: ruff check . --config pyproject.toml --exit-zero-if-unformatted

    - name: Run Static Type Checking (Mypy/Pyright Alternative)
      # Since this is a library/script repo, we enforce strict type checking.
      # Using 'mypy' standard for demonstration, ensure it's installed via uv/pip if needed.
      run: |
        if ! command -v mypy &> /dev/null; then
          uv pip install mypy
        fi
        mypy --strict --ignore-missing-imports . 

    - name: Run Pytest Unit and Integration Tests
      # Assuming tests are located in a 'tests/' directory
      run: pytest

    - name: Upload Coverage Report to Codecov (If Coverage Configured)
      if: success() && github.event_name == 'push'
      uses: codecov/codecov-action@v4
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        # Ensure this path matches where your coverage tool outputs (e.g., pytest --cov=./src)
        files: ./coverage.xml 
        flags: python${{ matrix.python-version }}

  deploy:
    name: Deploy Artifact (If Applicable)
    needs: build_and_test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
    - name: Deployment Placeholder
      run: echo "Deployment steps for PyPI/Artifact Registry go here."
